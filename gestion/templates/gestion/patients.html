{% extends "gestion/base.html" %}
{% load static %}

{% block title %}Gestion des Patients{% endblock %}
{% block page_title %}Gestion des Patients{% endblock %}
{% block patients_content %}

<style>
    /* Styles existants conservés */
    #add-patient-btn {
        background: linear-gradient(90deg, #4f8cff 0%, #38c6d9 100%);
        color: #fff;
        border: none;
        border-radius: 25px;
        padding: 12px 32px;
        font-size: 1.1rem;
        font-weight: 600;
        box-shadow: 0 4px 16px rgba(79,140,255,0.13);
        cursor: pointer;
        transition: background 0.18s, transform 0.18s, box-shadow 0.18s;
        letter-spacing: 0.5px;
        display: inline-flex;
        align-items: center;
        gap: 10px;
    }
    #add-patient-btn:hover {
        background: linear-gradient(90deg, #38c6d9 0%, #4f8cff 100%);
        transform: translateY(-2px) scale(1.03);
        box-shadow: 0 8px 24px rgba(56,198,217,0.18);
    }
    #add-patient-btn i {
        font-size: 1.2em;
    }

    #appointments-btn {
        background: linear-gradient(90deg, #28a745 0%, #218838 100%);
        color: #fff;
        border: none;
        border-radius: 25px;
        padding: 12px 32px;
        font-size: 1.1rem;
        font-weight: 600;
        box-shadow: 0 4px 16px rgba(40, 167, 69, 0.15);
        cursor: pointer;
        transition: background 0.18s, transform 0.18s, box-shadow 0.18s;
        letter-spacing: 0.5px;
        display: inline-flex;
        align-items: center;
        gap: 10px;
        margin-left: 15px;
        text-decoration: none;
    }
    #appointments-btn:hover {
        background: linear-gradient(90deg, #218838 0%, #28a745 100%);
        transform: translateY(-2px) scale(1.03);
        box-shadow: 0 8px 24px rgba(40, 167, 69, 0.25);
        text-decoration: none;
        color: #fff;
    }

    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0; top: 0;
        width: 100vw; height: 100vh;
        background: rgba(0,0,0,0.55);
        justify-content: center;
        align-items: center;
        animation: modal-bg-fade-in 0.35s;
    }

    .modal-content {
        background: #fff;
        border-radius: 14px;
        padding: 36px 32px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.18);
        position: relative;
        max-width: 900px;
        max-height: 90vh;
        overflow-y: auto;
        margin: auto;
        animation: modal-content-pop 0.38s cubic-bezier(.23,1.12,.32,1) both;
        width: 90%;
    }
    
    .patients-table {
        width: 100%;
        border-collapse: collapse;
        background: #fff;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        margin-bottom: 2rem;
    }
    .patients-table th, .patients-table td {
        padding: 12px 16px;
        text-align: left;
    }
    .patients-table thead {
       background: #1976d2;
        color: #fff;
;
        font-weight: 600;
    }
    .patients-table tbody tr {
        border-bottom: 1px solid #f0f0f0;
        transition: background 0.2s;
        animation: fadeInRow 0.7s cubic-bezier(.68,-0.55,.27,1.55);
    }
    .patients-table tbody tr:hover {
        background: #f0f7ff;
    }
    .patients-table td {
        color: #444;
    }
  

    .action-btn {
        border: none;
        background: none;
        cursor: pointer;
        margin: 0 2px;
        font-size: 0.9rem;
        border-radius: 6px;
        padding: 6px 10px;
        display: inline-flex; 
        align-items: center; 
        justify-content: center;
        transition: all 0.18s;
        gap: 4px;
    }
    .action-btn.edit {
        color: #1976d2;
        background: #e3f2fd;
    }
    .action-btn.delete {
        color: #e14c4c;
        background: #ffebee;
    }
    .action-btn.consult {
        color: #2e7d32;
        background: #e8f5e8;
    }
    .action-btn.details {
        color: #7b1fa2;
        background: #f3e5f5;
    }
    .action-btn:hover {
        transform: scale(1.05);
    }

    /* Styles pour la modal des détails */
    .patient-details-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 24px;
        border-radius: 12px;
        margin-bottom: 24px;
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .patient-avatar {
        width: 64px;
        height: 64px;
        border-radius: 50%;
        background: rgba(255,255,255,0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        font-weight: bold;
    }

    .patient-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 16px;
        margin-bottom: 32px;
    }

    .info-card {
        background: #f8f9fa;
        padding: 16px;
        border-radius: 8px;
        border-left: 4px solid #667eea;
    }

    .info-card h4 {
        margin: 0 0 8px 0;
        color: #333;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .info-card p {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 600;
        color: #555;
    }

    .consultations-section {
        margin-top: 32px;
    }

    .consultations-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 20px;
        padding-bottom: 12px;
        border-bottom: 2px solid #e9ecef;
    }

    .consultation-card {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 16px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .consultation-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }

    .consultation-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid #f0f0f0;
    }

    .consultation-date {
        font-weight: 600;
        color: #667eea;
        font-size: 1.1rem;
    }

    .doctor-name {
        background: #e8f4fd;
        color: #1976d2;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 500;
    }

    .consultation-details {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }

    .detail-group h5 {
        margin: 0 0 8px 0;
        color: #333;
        font-size: 0.95rem;
        font-weight: 600;
    }

    .detail-group p {
        margin: 0;
        color: #666;
        line-height: 1.5;
        background: #f8f9fa;
        padding: 8px 12px;
        border-radius: 6px;
        min-height: 20px;
    }

    .vital-signs {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 12px;
        margin: 16px 0;
        padding: 16px;
        background: #f0f7ff;
        border-radius: 8px;
    }

    .vital-sign {
        text-align: center;
    }

    .vital-sign .value {
        font-size: 1.2rem;
        font-weight: bold;
        color: #1976d2;
        display: block;
    }

    .vital-sign .label {
        font-size: 0.8rem;
        color: #666;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .no-consultations {
        text-align: center;
        padding: 40px;
        color: #666;
        background: #f8f9fa;
        border-radius: 8px;
        border: 2px dashed #dee2e6;
    }

    .step-content {
        display: none;
    }
    .step-content.active {
        display: block;
    }

    .step-indicator {
        display: flex;
        justify-content: center;
        margin-bottom: 30px;
        gap: 20px;
    }

    .step {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 20px;
        border-radius: 25px;
        background: #f5f5f5;
        color: #666;
        transition: all 0.3s;
    }

    .step.active {
        background: linear-gradient(90deg, #4f8cff 0%, #38c6d9 100%);
        color: white;
    }

    .step.completed {
        background: #4caf50;
        color: white;
    }

    .form-row {
        display: flex;
        gap: 15px;
        margin-bottom: 18px;
    }

    .form-group {
        flex: 1;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #333;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 12px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 1rem;
        transition: border-color 0.3s;
        box-sizing: border-box;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: #38c6d9;
    }

    .btn-group {
        display: flex;
        justify-content: space-between;
        margin-top: 30px;
    }

    .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn-primary {
        background: linear-gradient(90deg, #4f8cff 0%, #38c6d9 100%);
        color: white;
    }

    .btn-secondary {
        background: #6c757d;
        color: white;
    }

    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    @keyframes fadeInRow {
        0% { opacity:0; transform:translateY(18px) scale(0.98);}
        100% { opacity:1; transform:translateY(0) scale(1);}
    }
    
    @keyframes modal-bg-fade-in {
        from { background: rgba(0,0,0,0); }
        to   { background: rgba(0,0,0,0.55); }
    }
    
    @keyframes modal-content-pop {
        0% {
            opacity: 0;
            transform: translateY(60px) scale(0.96);
        }
        100% {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }
</style>

<div style="display: flex; justify-content: flex-end; margin-bottom: 18px;">
    <button id="add-patient-btn" class="btn">
        <i class="fas fa-user-plus"></i>
        Nouveau patient + Consultation
    </button>

    <a href="{% url 'appointments' %}" id="appointments-btn" class="btn">
        <i class="fas fa-calendar-check"></i> Gérer les Rendez-vous
    </a>
</div>

<h2>
    <i class="fas fa-list-ul" style="vertical-align:middle; margin-right:8px; color: #38c6d9;"></i>
    Liste des patients
</h2>
<div class="table-responsive">
    <table class="patients-table">
        <thead>
            <tr>
                <th>N°</th>
                <th>Nom</th>
                <th>Téléphone</th>
                <th>Sexe</th>
                <th>Date de naissance</th>
                <th>Adresse</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for patient in patients %}
            <tr data-patient-id="{{ patient.id }}">
                <td>{{ forloop.counter }}</td>
                <td>{{ patient.first_name }} {{ patient.last_name }}</td>
                <td>{{ patient.phone }}</td>
                <td>{{ patient.get_gender_display }}</td>
                <td>{{ patient.birth_date|date:"Y-m-d" }}</td>
                <td>{{ patient.address }}</td>
                <td>
                    <button class="action-btn details" title="Voir détails" onclick="viewPatientDetails(this)">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="action-btn edit" title="Modifier" onclick="editPatient(this)">
                        <i class="fas fa-pen"></i>
                    <button class="action-btn consult" title="Nouvelle consultation" 
                            onclick="openConsultationModal({{ patient.id }}, '{{ patient.first_name|addslashes }} {{ patient.last_name|addslashes }}')">
                        <i class="fas fa-stethoscope"></i>
                    </button>
                    <button class="action-btn schedule-appointment" title="Prendre Rendez-vous" onclick="openAppointmentModal(this)">
                        <i class="fas fa-calendar-plus"></i>
                    </button>
                    <button class="action-btn delete" title="Supprimer" onclick="deletePatient(this)">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="7" style="text-align:center; padding: 2rem;">Aucun patient enregistré</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Modale Détails Patient -->
<div id="patient-details-modal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closePatientDetailsModal()" style="position:absolute; top:10px; right: 20px; font-size:2rem; cursor:pointer; color:#888;">×</span>
        
        <div id="patient-details-content">
            <!-- Le contenu sera chargé dynamiquement via JavaScript -->
        </div>
    </div>
</div>

<!-- Modale Patient + Consultation (2 étapes) -->
<div id="patient-modal" class="modal">
    <div class="modal-content">
        <span class="close" id="close-modal" style="position:absolute; top:10px; right: 20px; font-size:2rem; cursor:pointer; color:#888;">×</span>
        
        <div class="step-indicator">
            <div class="step active" id="step-1-indicator">
                <i class="fas fa-user"></i><span>Informations Patient</span>
            </div>
            <div class="step" id="step-2-indicator">
                <i class="fas fa-stethoscope"></i><span>Consultation</span>
            </div>
        </div>

        <form id="patient-consultation-form" method="post">
            {% csrf_token %}
            <input type="hidden" id="patient-id" name="patient_id">
            
            <!-- Étape 1: Informations du patient -->
            <div id="step-1" class="step-content active">
                <h2 style="margin-top:0; font-size:1.8rem; text-align:center;">
                    <i class="fas fa-user-plus"></i> Informations Patient
                </h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="first_name">Prénom *</label>
                        <input type="text" id="first_name" name="first_name" required>
                    </div>
                    <div class="form-group">
                        <label for="last_name">Nom *</label>
                        <input type="text" id="last_name" name="last_name" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="phone">Téléphone *</label>
                        <input type="tel" id="phone" name="phone" required>
                    </div>
                    <div class="form-group">
                        <label for="gender">Sexe *</label>
                        <select id="gender" name="gender" required>
                            <option value="">Sélectionner</option>
                            <option value="M">Masculin</option>
                            <option value="F">Féminin</option>
                            <option value="O">Autre</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="birth_date">Date de naissance *</label>
                    <input type="date" id="birth_date" name="birth_date" required>
                </div>
                <div class="form-group">
                    <label for="address">Adresse</label>
                    <textarea id="address" name="address" rows="3"></textarea>
                </div>
                <div class="btn-group">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Annuler</button>
                    <button type="button" class="btn btn-primary" onclick="nextStep()">
                        Suivant <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
            
            <!-- Étape 2: Consultation médicale -->
            <div id="step-2" class="step-content">
                <h2 style="margin-top:0; font-size:1.8rem; text-align:center;">
                    <i class="fas fa-stethoscope"></i> Consultation Médicale
                </h2>
                <div class="form-group">
                    <label for="doctor">Médecin consultant *</label>
                    <select id="doctor" name="doctor" required>
                        <option value="">Sélectionner un médecin</option>
                        {% for doctor in doctors %}
                        <option value="{{ doctor.id }}">
                            Dr. {{ doctor.user.first_name }} {{ doctor.user.last_name }} - {{ doctor.specialty }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <h3 style="color: #2e7d32; margin: 25px 0 15px 0;">
                    <i class="fas fa-heartbeat"></i> Signes vitaux
                </h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="weight">Poids (kg)</label>
                        <input type="number" id="weight" name="weight" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="height">Taille (cm)</label>
                        <input type="number" id="height" name="height" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="temperature">Température (°C)</label>
                        <input type="number" id="temperature" name="temperature" step="0.1">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="blood_pressure_systolic">Tension systolique</label>
                        <input type="number" id="blood_pressure_systolic" name="blood_pressure_systolic">
                    </div>
                    <div class="form-group">
                        <label for="blood_pressure_diastolic">Tension diastolique</label>
                        <input type="number" id="blood_pressure_diastolic" name="blood_pressure_diastolic">
                    </div>
                    <div class="form-group">
                        <label for="heart_rate">Fréquence cardiaque (bpm)</label>
                        <input type="number" id="heart_rate" name="heart_rate">
                    </div>
                </div>
                <h3 style="color: #2e7d32; margin: 25px 0 15px 0;">
                    <i class="fas fa-notes-medical"></i> Informations cliniques
                </h3>
                <div class="form-group">
                    <label for="symptoms">Symptômes *</label>
                    <textarea id="symptoms" name="symptoms" rows="3" required></textarea>
                </div>
                <div class="form-group">
                    <label for="diagnosis">Diagnostic</label>
                    <textarea id="diagnosis" name="diagnosis" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="treatment">Traitement prescrit</label>
                    <textarea id="treatment" name="treatment" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="notes">Notes additionnelles</label>
                    <textarea id="notes" name="notes" rows="2"></textarea>
                </div>
                <div class="btn-group">
                    <button type="button" class="btn btn-secondary" onclick="previousStep()">
                        <i class="fas fa-arrow-left"></i> Précédent
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Enregistrer Tout
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Modale consultation seule (pour patients existants) -->
<div id="consultation-modal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeConsultationModal()" style="position:absolute; top:10px; right: 20px; font-size:2rem; cursor:pointer; color:#888;">×</span>
        <h2 style="margin-top:0; font-size:1.8rem;">
            <i class="fas fa-stethoscope"></i> Nouvelle Consultation
        </h2>
        <div id="patient-info" class="consultation-summary" style="background:#f8f9fa; border-radius:8px; padding:20px; margin:20px 0;"></div>
        
        <form id="consultation-form" method="post">
            {% csrf_token %}
            <input type="hidden" id="consult-patient-id" name="patient_id">
            
            <div class="form-group">
                <label for="consult-doctor">Médecin consultant *</label>
                <select id="consult-doctor" name="doctor" required>
                    <option value="">Sélectionner un médecin</option>
                    {% for doctor in doctors %}
                    <option value="{{ doctor.id }}">
                        Dr. {{ doctor.user.first_name }} {{ doctor.user.last_name }} - {{ doctor.specialty }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <h3 style="color: #2e7d32; margin: 25px 0 15px 0;">
                <i class="fas fa-heartbeat"></i> Signes vitaux
            </h3>
            <div class="form-row">
                <div class="form-group">
                    <label for="consult-weight">Poids (kg)</label>
                    <input type="number" id="consult-weight" name="weight" step="0.1">
                </div>
                <div class="form-group">
                    <label for="consult-height">Taille (cm)</label>
                    <input type="number" id="consult-height" name="height" step="0.1">
                </div>
                <div class="form-group">
                    <label for="consult-temperature">Température (°C)</label>
                    <input type="number" id="consult-temperature" name="temperature" step="0.1">
                </div>
            </div>
            <h3 style="color: #2e7d32; margin: 25px 0 15px 0;">
                <i class="fas fa-notes-medical"></i> Informations cliniques
            </h3>
            <div class="form-group">
                <label for="consult-symptoms">Symptômes *</label>
                <textarea id="consult-symptoms" name="symptoms" rows="3" required></textarea>
            </div>
            <div class="form-group">
                <label for="consult-diagnosis">Diagnostic</label>
                <textarea id="consult-diagnosis" name="diagnosis" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label for="consult-treatment">Traitement prescrit</label>
                <textarea id="consult-treatment" name="treatment" rows="3"></textarea>
            </div>
            <div class="btn-group">
                <button type="button" class="btn btn-secondary" onclick="closeConsultationModal()">Annuler</button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Enregistrer Consultation
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modale Prendre Rendez-vous -->
<div id="appointment-modal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeAppointmentModal()" style="position:absolute; top:10px; right: 20px; font-size:2rem; cursor:pointer; color:#888;">×</span>
        <h2 style="margin-top:0; font-size:1.5rem;">
            <i class="fas fa-calendar-plus"></i> Prendre Rendez-vous
        </h2>
        <form id="appointment-form" method="post">
            {% csrf_token %}
            <input type="hidden" id="appointment-patient-id" name="patient_id">
            <div class="form-group">
                <label for="appointment-doctor">Médecin *</label>
                <select id="appointment-doctor" name="doctor" required>
                    <option value="">Sélectionner un médecin</option>
                    {% for doctor in doctors %}
                    <option value="{{ doctor.id }}">
                        Dr. {{ doctor.user.first_name }} {{ doctor.user.last_name }} - {{ doctor.specialty }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="appointment-date">Date *</label>
                <input type="date" id="appointment-date" name="date" required>
            </div>
            <div class="form-group">
                <label for="appointment-time">Créneau disponible *</label>
                <select id="appointment-time" name="time" required>
                    <option value="">Sélectionner un créneau</option>
                </select>
            </div>
            <div class="form-group">
                <label for="appointment-reason">Motif du rendez-vous *</label>
                <textarea id="appointment-reason" name="reason" rows="2" required></textarea>
            </div>
            <div class="btn-group">
                <button type="button" class="btn btn-secondary" onclick="closeAppointmentModal()">Annuler</button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Enregistrer Rendez-vous
                </button>
            </div>
        </form>
    </div>
</div>
<script>// Variables globales
let isEditMode = false;
let currentStep = 1;

document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM chargé - Initialisation du système de gestion des patients');
    
    // Initialisation des événements
    initializeEventListeners();
});

function initializeEventListeners() {
    // Bouton nouveau patient
    const addPatientBtn = document.getElementById('add-patient-btn');
    if (addPatientBtn) {
        addPatientBtn.addEventListener('click', openPatientModal);
    }

    // Boutons de fermeture des modales
    const closeButtons = document.querySelectorAll('.close');
    closeButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            closeAllModals();
        });
    });

    // Fermeture des modales en cliquant à l'extérieur
    window.addEventListener('click', function(event) {
        const modals = document.querySelectorAll('.modal');
        modals.forEach(modal => {
            if (event.target === modal) {
                closeAllModals();
            }
        });
    });

    // Formulaires
    initializeFormHandlers();
}

function initializeFormHandlers() {
    // Formulaire patient + consultation
    const patientConsultationForm = document.getElementById('patient-consultation-form');
    if (patientConsultationForm) {
        patientConsultationForm.addEventListener('submit', handlePatientConsultationSubmit);
    }

    // Formulaire consultation seule
    const consultationForm = document.getElementById('consultation-form');
    if (consultationForm) {
        consultationForm.addEventListener('submit', handleConsultationSubmit);
    }

    // Formulaire rendez-vous
    const appointmentForm = document.getElementById('appointment-form');
    if (appointmentForm) {
        appointmentForm.addEventListener('submit', handleAppointmentSubmit);
    }
}

// ===== GESTION DES MODALES =====
function openPatientModal() {
    // Réinitialise le formulaire avant toute chose
    resetPatientForm();
    currentStep = 1;

    const modal = document.getElementById('patient-modal');
    const step1 = document.getElementById('step-1');
    const step2 = document.getElementById('step-2');
    const step1Indicator = document.getElementById('step-1-indicator');
    const step2Indicator = document.getElementById('step-2-indicator');

    if (isEditMode) {
        // --- CONFIGURATION POUR LE MODE MODIFICATION ---
        
        // Change le titre
        step1.querySelector('h2').innerHTML = '<i class="fas fa-user-edit"></i> Modifier les informations du patient';
        
        // Cache l'étape 2 et son indicateur
        step2.style.display = 'none';
        step2Indicator.style.display = 'none';
        step1Indicator.classList.add('active');
        step1Indicator.classList.remove('completed');
        
        // Cache les boutons de navigation multi-étapes
        step1.querySelector('button[onclick="nextStep()"]').style.display = 'none';
        
        // Affiche un bouton "Enregistrer" spécifique à l'étape 1
        const btnGroup = step1.querySelector('.btn-group');
        let saveEditBtn = btnGroup.querySelector('#save-edit-btn');
        if (!saveEditBtn) {
            saveEditBtn = document.createElement('button');
            saveEditBtn.type = 'submit';
            saveEditBtn.id = 'save-edit-btn';
            saveEditBtn.className = 'btn btn-primary';
            saveEditBtn.innerHTML = '<i class="fas fa-save"></i> Enregistrer les modifications';
            btnGroup.appendChild(saveEditBtn);
        }
        saveEditBtn.style.display = 'inline-block';
        
    } else {
        // --- CONFIGURATION POUR LE MODE CRÉATION (comportement par défaut) ---
        
        // Rétablit le titre
        step1.querySelector('h2').innerHTML = '<i class="fas fa-user-plus"></i> Informations Patient';
        
        // Affiche l'étape 2 et son indicateur
        step2.style.display = 'block'; // S'assure qu'il est de type bloc
        step2Indicator.style.display = 'flex';
        
        // Affiche le bouton "Suivant"
        step1.querySelector('button[onclick="nextStep()"]').style.display = 'inline-block';
        
        // Cache le bouton de sauvegarde de l'édition
        const saveEditBtn = step1.querySelector('#save-edit-btn');
        if (saveEditBtn) {
            saveEditBtn.style.display = 'none';
        }

        // Réinitialise les étapes à l'état initial
        showStep(1);
    }

    // Affiche la modale
    modal.style.display = 'flex';
    
    // Focus sur le premier champ
    setTimeout(() => { document.getElementById('first_name').focus(); }, 100);
}

function closeModal() {
    document.getElementById('patient-modal').style.display = 'none';
    resetPatientForm();
    currentStep = 1;
}

function closeAllModals() {
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
        modal.style.display = 'none';
    });
    resetPatientForm();
    currentStep = 1;
}

function openConsultationModal(patientId, patientName) {
    // 1. Vide l'ancien contenu du formulaire (important!)
    resetConsultationForm();

    // 2. Injecte l'ID du patient dans le champ caché
    document.getElementById('consult-patient-id').value = patientId;
    
    // 3. Affiche le nom du patient dans l'entête de la modale pour confirmation
    const patientInfoDiv = document.getElementById('patient-info');
    patientInfoDiv.innerHTML = `
        <h4 style="margin: 0; font-weight: bold;">
            <i class="fas fa-user-injured"></i> Patient : ${patientName}
        </h4>
        <p style="margin: 5px 0 0; color: #666;">ID Patient: ${patientId}</p>
    `;
    
    // 4. Affiche la modale
    document.getElementById('consultation-modal').style.display = 'flex';
}

function closeConsultationModal() {
    document.getElementById('consultation-modal').style.display = 'none';
    resetConsultationForm();
}

function openAppointmentModal(button) {
    const row = button.closest('tr');
    const patientId = row.getAttribute('data-patient-id');
    
    document.getElementById('appointment-modal').style.display = 'flex';
    document.getElementById('appointment-patient-id').value = patientId;
    
    // Définir la date minimum à aujourd'hui
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('appointment-date').min = today;
    
    resetAppointmentForm();
}

function closeAppointmentModal() {
    document.getElementById('appointment-modal').style.display = 'none';
    resetAppointmentForm();
}

function closePatientDetailsModal() {
    document.getElementById('patient-details-modal').style.display = 'none';
}

// ===== NAVIGATION ENTRE ÉTAPES =====

function showStep(stepNumber) {
    // Masquer toutes les étapes
    document.querySelectorAll('.step-content').forEach(step => {
        step.classList.remove('active');
    });
    
    // Afficher l'étape courante
    document.getElementById(`step-${stepNumber}`).classList.add('active');
    
    // Mettre à jour les indicateurs
    updateStepIndicators(stepNumber);
    
    currentStep = stepNumber;
}

function updateStepIndicators(activeStep) {
    for (let i = 1; i <= 2; i++) {
        const indicator = document.getElementById(`step-${i}-indicator`);
        indicator.classList.remove('active', 'completed');
        
        if (i < activeStep) {
            indicator.classList.add('completed');
        } else if (i === activeStep) {
            indicator.classList.add('active');
        }
    }
}

function nextStep() {
    if (currentStep === 1) {
        if (validateStep1()) {
            showStep(2);
        }
    }
}

function previousStep() {
    if (currentStep === 2) {
        showStep(1);
    }
}

function validateStep1() {
    const requiredFields = ['first_name', 'last_name', 'phone', 'gender', 'birth_date'];
    let isValid = true;
    
    requiredFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (!field.value.trim()) {
            field.style.borderColor = '#e74c3c';
            isValid = false;
            
            // Animation d'erreur
            field.style.animation = 'shake 0.5s';
            setTimeout(() => {
                field.style.animation = '';
            }, 500);
        } else {
            field.style.borderColor = '#e0e0e0';
        }
    });
    
    if (!isValid) {
        showNotification('Veuillez remplir tous les champs obligatoires', 'error');
    }
    
    return isValid;
}

// ===== ACTIONS SUR LES PATIENTS =====

function viewPatientDetails(button) {
    const row = button.closest('tr');
    const patientId = row.getAttribute('data-patient-id');
    
    // Afficher un loader
    showLoader();
    
    // Simulation d'un appel AJAX pour récupérer les détails
    fetchPatientDetails(patientId)
        .then(data => {
            displayPatientDetails(data);
            document.getElementById('patient-details-modal').style.display = 'flex';
        })
        .catch(error => {
            console.error('Erreur lors du chargement des détails:', error);
            showNotification('Erreur lors du chargement des détails du patient', 'error');
        })
        .finally(() => {
            hideLoader();
        });
}

function editPatient(button) {
    const row = button.closest('tr');
    const patientId = row.getAttribute('data-patient-id');
    
    showLoader();
    
    // On met isEditMode à true AVANT d'appeler fetch
    isEditMode = true;

    fetchPatientData(patientId)
        .then(data => {
            // Ouvre la modale qui va maintenant se configurer en mode édition
            openPatientModal();
            
            // Remplit le formulaire avec les données reçues
            populatePatientForm(data);
            
            // Ne pas oublier de mettre l'ID dans le champ caché principal
            document.getElementById('patient-id').value = patientId;
        })
        .catch(error => {
            console.error('Erreur lors du chargement du patient:', error);
            showNotification('Erreur lors du chargement des données du patient', 'error');
            isEditMode = false; // Réinitialiser en cas d'erreur
        })
        .finally(() => {
            hideLoader();
        });
}

function deletePatient(button) {
    const row = button.closest('tr');
    const patientId = row.getAttribute('data-patient-id');
    const patientName = row.cells[1].textContent;
    
    if (confirm(`Êtes-vous sûr de vouloir supprimer le patient ${patientName} ?\n\nCette action est irréversible et supprimera également toutes les consultations associées.`)) {
        showLoader();
        
        // Simulation d'une suppression
        deletePatientRequest(patientId)
            .then(() => {
                // Animation de suppression
                row.style.animation = 'fadeOut 0.5s';
                setTimeout(() => {
                    row.remove();
                    showNotification('Patient supprimé avec succès', 'success');
                    updateTableNumbers();
                }, 500);
            })
            .catch(error => {
                console.error('Erreur lors de la suppression:', error);
                showNotification('Erreur lors de la suppression du patient', 'error');
            })
            .finally(() => {
                hideLoader();
            });
    }
}

// ===== GESTION DES FORMULAIRES =====
function handlePatientConsultationSubmit(event) {
    event.preventDefault();
    
    if (currentStep === 1 && !isEditMode) { // Si on est à l'étape 1 et en mode création
        nextStep();
        return;
    }
    
    const formData = new FormData(event.target);
    showLoader();
    
    const action = isEditMode ? 'mise à jour' : 'enregistrement';
    
    submitPatientConsultation(formData)
        .then(response => {
            if (response.success) {
                showNotification(response.message, 'success');
                closeAllModals(); // Utiliser closeAllModals pour tout fermer
                
                if (isEditMode) {
                    // Mettre à jour la ligne existante
                    updatePatientInTable(response.patient);
                } else {
                    // Ajouter une nouvelle ligne
                    addPatientToTable(response.patient);
                }
            } else {
                showNotification(response.message || `Erreur lors de la ${action}`, 'error');
            }
        })
        .catch(error => {
            console.error(`Erreur ${action}:`, error);
            showNotification(error.message || `Erreur critique lors de la ${action}`, 'error');
        })
        .finally(() => {
            hideLoader();
        });
}

function handleConsultationSubmit(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    showLoader();
    
    submitConsultation(formData)
        .then(response => {
            if (response.success) {
                showNotification('Consultation enregistrée avec succès!', 'success');
                closeConsultationModal();
            } else {
                showNotification(response.message || 'Erreur lors de l\'enregistrement', 'error');
            }
        })
        .catch(error => {
            console.error('Erreur consultation:', error);
            showNotification('Erreur lors de l\'enregistrement de la consultation', 'error');
        })
        .finally(() => {
            hideLoader();
        });
}

function handleAppointmentSubmit(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    showLoader();
    
    submitAppointment(formData)
        .then(response => {
            if (response.success) {
                showNotification('Rendez-vous programmé avec succès!', 'success');
                closeAppointmentModal();
                // Ajout : rafraîchir la page pour voir le rendez-vous dans la liste
                setTimeout(() => { location.reload(); }, 800);
            } else {
                showNotification(response.message || 'Erreur lors de la programmation', 'error');
            }
        })
        .catch(error => {
            console.error('Erreur rendez-vous:', error);
            showNotification('Erreur lors de la programmation du rendez-vous', 'error');
        })
        .finally(() => {
            hideLoader();
        });
}

// ===== FONCTIONS UTILITAIRES =====
function resetPatientForm() {
    isEditMode = false; // Réinitialise le mode
    
    const form = document.getElementById('patient-consultation-form');
    if (form) {
        form.reset();
        document.getElementById('patient-id').value = '';
        
        // Réinitialiser les styles des champs
        form.querySelectorAll('input, select, textarea').forEach(field => {
            field.style.borderColor = '#e0e0e0';
        });

        // S'assurer que les boutons sont dans leur état par défaut pour la création
        const step1 = document.getElementById('step-1');
        const saveEditBtn = step1.querySelector('#save-edit-btn');
        if (saveEditBtn) {
            saveEditBtn.style.display = 'none';
        }
        step1.querySelector('button[onclick="nextStep()"]').style.display = 'inline-block';
        document.getElementById('step-2-indicator').style.display = 'flex';
    }
}


function resetConsultationForm() {
    const form = document.getElementById('consultation-form');
    if (form) {
        form.reset();
        document.getElementById('consult-patient-id').value = '';
    }
}

function resetAppointmentForm() {
    const form = document.getElementById('appointment-form');
    if (form) {
        form.reset();
        document.getElementById('appointment-patient-id').value = '';
    }
}

function populatePatientForm(data) {
    document.getElementById('first_name').value = data.first_name || '';
    document.getElementById('last_name').value = data.last_name || '';
    document.getElementById('phone').value = data.phone || '';
    document.getElementById('gender').value = data.gender || '';
    document.getElementById('birth_date').value = data.birth_date || '';
    document.getElementById('address').value = data.address || '';
}

function showNotification(message, type = 'info') {
    // Créer une notification toast
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.innerHTML = `
        <div class="notification-content">
            <i class="fas ${getNotificationIcon(type)}"></i>
            <span>${message}</span>
        </div>
    `;
    
    // Styles pour la notification
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${getNotificationColor(type)};
        color: white;
        padding: 16px 24px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 2000;
        animation: slideInRight 0.3s ease;
        min-width: 300px;
    `;
    
    document.body.appendChild(notification);
    
    // Supprimer après 3 secondes
    setTimeout(() => {
        notification.style.animation = 'slideOutRight 0.3s ease';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

function getNotificationIcon(type) {
    const icons = {
        success: 'fa-check-circle',
        error: 'fa-exclamation-circle',
        warning: 'fa-exclamation-triangle',
        info: 'fa-info-circle'
    };
    return icons[type] || icons.info;
}

function getNotificationColor(type) {
    const colors = {
        success: '#4caf50',
        error: '#f44336',
        warning: '#ff9800',
        info: '#2196f3'
    };
    return colors[type] || colors.info;
}

function showLoader() {
    let loader = document.getElementById('global-loader');
    if (!loader) {
        loader = document.createElement('div');
        loader.id = 'global-loader';
        loader.innerHTML = `
            <div class="loader-content">
                <div class="spinner"></div>
                <p>Chargement...</p>
            </div>
        `;
        loader.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 3000;
        `;
        document.body.appendChild(loader);
    }
    loader.style.display = 'flex';
}

function hideLoader() {
    const loader = document.getElementById('global-loader');
    if (loader) {
        loader.style.display = 'none';
    }
}

function updateTableNumbers() {
    const rows = document.querySelectorAll('.patients-table tbody tr');
    rows.forEach((row, index) => {
        if (row.cells.length > 0) {
            row.cells[0].textContent = index + 1;
        }
    });
}

// ===== FONCTIONS D'API (À ADAPTER SELON VOTRE BACKEND) =====
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');

async function fetchPatientDetails(patientId) {
    // Utilise l'URL définie dans urls.py
    const response = await fetch(`/api/patient/${patientId}/details/`); 
    if (!response.ok) throw new Error('Erreur réseau');
    const result = await response.json();
    if (!result.success) throw new Error(result.message || 'Erreur serveur');
    return result.data; // La vue renvoie les données dans une clé 'data'
}

async function fetchPatientData(patientId) {
    // Utilise l'URL définie dans urls.py pour la modification
    const response = await fetch(`/api/patient/${patientId}/data/`);
    if (!response.ok) throw new Error('Erreur réseau');
    const result = await response.json();
    if (!result.success) throw new Error(result.message || 'Erreur serveur');
    return result.patient; // La vue renvoie les données dans une clé 'patient'
}
async function submitPatientConsultation(formData) {
    // Utilise l'URL définie dans urls.py
    const response = await fetch('/api/patient/save/', {
        method: 'POST',
        body: formData,
        headers: { 'X-CSRFToken': csrftoken }
    });
    if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.message || 'Erreur réseau');
    }
    return await response.json();
}

async function submitConsultation(formData) {
    // Utilise l'URL définie dans urls.py
    const response = await fetch('/api/consultation/add/', {
        method: 'POST',
        body: formData,
        headers: { 'X-CSRFToken': csrftoken }
    });
    if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.message || 'Erreur réseau');
    }
    return await response.json();
}

async function submitAppointment(formData) {
    // Remplacer par votre endpoint réel
    const response = await fetch('/api/appointments/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    });
    if (!response.ok) throw new Error('Erreur réseau');
    return await response.json();
}

async function deletePatientRequest(patientId) {
    // Utilise l'URL et la méthode DELETE définies dans urls.py
    const response = await fetch(`/api/patient/${patientId}/delete/`, {
        method: 'DELETE', // Changé de POST à DELETE
        headers: { 'X-CSRFToken': csrftoken }
    });
    if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.message || 'Erreur réseau');
    }
    return await response.json();
}

function displayPatientDetails(data) {
    const content = document.getElementById('patient-details-content');
    content.innerHTML = `
        <div class="patient-details-header">
            <div class="patient-avatar">
                ${data.first_name.charAt(0)}${data.last_name.charAt(0)}
            </div>
            <div>
                <h2 style="margin: 0;">${data.first_name} ${data.last_name}</h2>
                <p style="margin: 5px 0 0 0; opacity: 0.9;">${data.phone}</p>
            </div>
        </div>
        
        <div class="patient-info-grid">
            <div class="info-card">
                <h4>Sexe</h4>
                <p>${data.gender_display || 'Non spécifié'}</p>
            </div>
            <div class="info-card">
                <h4>Date de naissance</h4>
                <p>${data.birth_date || 'Non spécifiée'}</p>
            </div>
            <div class="info-card">
                <h4>Âge</h4>
                <p>${data.age || 'N/A'} ans</p>
            </div>
            <div class="info-card">
                <h4>Adresse</h4>
                <p>${data.address || 'Non spécifiée'}</p>
            </div>
        </div>
        
        <div class="consultations-section">
            <div class="consultations-header">
                <h3><i class="fas fa-history"></i> Historique des consultations</h3>
            </div>
            ${data.consultations && data.consultations.length > 0 ? 
                data.consultations.map(consultation => `
                    <div class="consultation-card">
                        <div class="consultation-header">
                            <span class="consultation-date">${consultation.date}</span>
                            <span class="doctor-name">Dr. ${consultation.doctor_name}</span>
                        </div>
                        <div class="consultation-details">
                            <div class="detail-group">
                                <h5>Symptômes</h5>
                                <p>${consultation.symptoms || 'Non spécifiés'}</p>
                            </div>
                            <div class="detail-group">
                                <h5>Diagnostic</h5>
                                <p>${consultation.diagnosis || 'Non spécifié'}</p>
                            </div>
                        </div>
                        ${consultation.vital_signs ? `
                            <div class="vital-signs">
                                ${consultation.vital_signs.weight ? `<div class="vital-sign"><span class="value">${consultation.vital_signs.weight}</span><span class="label">Poids (kg)</span></div>` : ''}
                                ${consultation.vital_signs.height ? `<div class="vital-sign"><span class="value">${consultation.vital_signs.height}</span><span class="label">Taille (cm)</span></div>` : ''}
                                ${consultation.vital_signs.temperature ? `<div class="vital-sign"><span class="value">${consultation.vital_signs.temperature}</span><span class="label">Temp. (°C)</span></div>` : ''}
                            </div>
                        ` : ''}
                    </div>
                `).join('') :
                '<div class="no-consultations"><i class="fas fa-info-circle"></i><br>Aucune consultation enregistrée</div>'
            }
        </div>
    `;
}

function addPatientToTable(patient, consultation) {
    const tbody = document.querySelector('.patients-table tbody');
    const emptyRow = tbody.querySelector('td[colspan="7"]');
    
    if (emptyRow) {
        emptyRow.parentNode.remove();
    }
    
    const newRow = document.createElement('tr');
    newRow.setAttribute('data-patient-id', patient.id);
    newRow.innerHTML = `
        <td>${tbody.children.length + 1}</td>
        <td>${patient.first_name} ${patient.last_name}</td>
        <td>${patient.phone}</td>
        <td>${patient.gender_display}</td>
        <td>${patient.birth_date}</td>
        <td>${patient.address || ''}</td>
        <td>
            <button class="action-btn details" title="Voir détails" onclick="viewPatientDetails(this)">
                <i class="fas fa-eye"></i>
            </button>
            <button class="action-btn edit" title="Modifier" onclick="editPatient(this)">
                <i class="fas fa-pen"></i>
            </button>
            <button class="action-btn consult" title="Nouvelle consultation" onclick="newConsultation(this)">
                <i class="fas fa-stethoscope"></i>
            </button>
            <button class="action-btn schedule-appointment" title="Prendre Rendez-vous" onclick="openAppointmentModal(this)">
                <i class="fas fa-calendar-plus"></i>
            </button>
            <button class="action-btn delete" title="Supprimer" onclick="deletePatient(this)">
                <i class="fas fa-trash"></i>
            </button>
        </td>
    `;
    
    tbody.appendChild(newRow);
    newRow.style.animation = 'fadeInRow 0.7s cubic-bezier(.68,-0.55,.27,1.55)';
}

function updatePatientInTable(patient) {
    const row = document.querySelector(`tr[data-patient-id="${patient.id}"]`);
    if (row) {
        row.cells[1].textContent = `${patient.first_name} ${patient.last_name}`;
        row.cells[2].textContent = patient.phone;
        row.cells[3].textContent = patient.gender_display;
        row.cells[4].textContent = patient.birth_date;
        row.cells[5].textContent = patient.address || '';
        
        // Animation de mise à jour
        row.style.animation = 'highlightUpdate 1s ease';
    }
}

// Ajouter les animations CSS manquantes
const additionalStyles = `
    <style>
        @keyframes fadeOut {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(100%); }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        
        @keyframes highlightUpdate {
            0% { background-color: #e8f5e8; }
            100% { background-color: transparent; }
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #38c6d9;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loader-content {
            text-align: center;
            color: white;
            font-size: 1.1rem;
        }
    </style>
`;

// Injecter les styles additionnels
document.head.insertAdjacentHTML('beforeend', additionalStyles);

// --- AJOUT: Gestion dynamique des créneaux disponibles ---
document.addEventListener('DOMContentLoaded', function() {
    const doctorSelect = document.getElementById('appointment-doctor');
    const dateInput = document.getElementById('appointment-date');
    const timeSelect = document.getElementById('appointment-time');

    function updateAvailableSlots() {
        const doctorId = doctorSelect.value;
        const date = dateInput.value;
        timeSelect.innerHTML = '<option value="">Chargement...</option>';
        if (doctorId && date) {
            fetch(`/get-slots/?doctor_id=${doctorId}&date=${date}`)
                .then(resp => resp.json())
                .then(data => {
                    timeSelect.innerHTML = '';
                    if (data.slots && data.slots.length > 0) {
                        data.slots.forEach(slot => {
                            const opt = document.createElement('option');
                            opt.value = slot;
                            opt.textContent = slot;
                            timeSelect.appendChild(opt);
                        });
                    } else {
                        const opt = document.createElement('option');
                        opt.value = '';
                        opt.textContent = 'Aucun créneau disponible';
                        timeSelect.appendChild(opt);
                    }
                })
                .catch(() => {
                    timeSelect.innerHTML = '<option value="">Erreur lors du chargement</option>';
                });
        } else {
            timeSelect.innerHTML = '<option value="">Sélectionner un créneau</option>';
        }
    }

    if (doctorSelect && dateInput) {
        doctorSelect.addEventListener('change', updateAvailableSlots);
        dateInput.addEventListener('change', updateAvailableSlots);
    }
});
</script>
{% endblock patients_content %}